import React, { useState, useEffect } from 'react';
import { CalculatorResult } from '../../types';
import { 
    convertHbA1cToEAG, convertEAGToHbA1c, convertHbA1cToGA, convertGAToHbA1c, 
    calculateHOMAIR, calculateBMI, checkMetabolicSyndrome, calculateFINDRISC
} from '../../utils/calculations';
import { ResultCard, InputGroup, NumberInput, Checkbox, formatEMR } from './Shared';
import { RotateCcw, Info, Copy } from 'lucide-react';

export const HbA1cCalculator: React.FC = () => { const [a1c, setA1c] = useState<number|''>(''); const [eag, setEag] = useState<number|''>(''); const handleA1cChange = (val: number) => { setA1c(val); if (val) setEag(convertHbA1cToEAG(val)); else setEag(''); }; const handleEagChange = (val: number) => { setEag(val); if (val) setA1c(convertEAGToHbA1c(val)); else setA1c(''); }; const copyText = `[HbA1c-eAG]\nHbA1c: ${a1c} %\neAG: ${eag} mg/dL`; return ( <div className="max-w-md space-y-4"> <div className="p-6 bg-white border-2 border-slate-200 rounded-xl shadow-sm"> <div className="grid grid-cols-[1fr,auto,1fr] gap-4 items-end"> <InputGroup label="HbA1c (%)"> <NumberInput value={a1c} onChange={handleA1cChange} step="0.1" /> </InputGroup> <div className="pb-6 text-slate-400"> <RotateCcw size={24} /> </div> <InputGroup label="eAG (mg/dL)"> <NumberInput value={eag} onChange={handleEagChange} /> </InputGroup> </div> <div className="mt-4 p-3 bg-slate-100 rounded text-sm text-black font-bold"> <Info size={16} className="inline mr-2 mb-0.5 text-slate-600" /> 輸入任一數值可自動換算。 </div> </div> {a1c && ( <div className="flex justify-end"> <button onClick={() => navigator.clipboard.writeText(copyText)} className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-black border border-slate-300"> <Copy size={16}/> 複製結果 </button> </div> )} </div> ) }

export const GACalculator: React.FC = () => { const [a1c, setA1c] = useState<number|''>(''); const [ga, setGa] = useState<number|''>(''); const handleA1cChange = (val: number) => { setA1c(val); if (val) setGa(convertHbA1cToGA(val)); else setGa(''); }; const handleGaChange = (val: number) => { setGa(val); if (val) setA1c(convertGAToHbA1c(val)); else setA1c(''); }; const copyText = `[HbA1c-GA]\nHbA1c: ${a1c} %\nGA: ${ga} %`; return ( <div className="max-w-md space-y-4"> <div className="p-6 bg-white border-2 border-slate-200 rounded-xl shadow-sm"> <div className="grid grid-cols-[1fr,auto,1fr] gap-4 items-end"> <InputGroup label="HbA1c (%)"> <NumberInput value={a1c} onChange={handleA1cChange} step="0.1" /> </InputGroup> <div className="pb-6 text-slate-400"> <RotateCcw size={24} /> </div> <InputGroup label="GA (%)"> <NumberInput value={ga} onChange={handleGaChange} step="0.1" /> </InputGroup> </div> <div className="mt-4 p-3 bg-slate-100 rounded text-sm text-black font-bold"> <Info size={16} className="inline mr-2 mb-0.5 text-slate-600" /> 公式: GA = (HbA1c - 2.015) x 4 </div> </div> {a1c && ( <div className="flex justify-end"> <button onClick={() => navigator.clipboard.writeText(copyText)} className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-black border border-slate-300"> <Copy size={16}/> 複製結果 </button> </div> )} </div> ) }

export const HOMAIRCalculator: React.FC = () => { const [glu, setGlu] = useState<number|''>(''); const [ins, setIns] = useState<number|''>(''); const [result, setResult] = useState<CalculatorResult|null>(null); useEffect(() => { if(glu && ins) setResult(calculateHOMAIR(Number(glu), Number(ins))); else setResult(null); }, [glu, ins]); const copyText = formatEMR('HOMA-IR', `Glu ${glu}, Ins ${ins}`, result); return (<div className="max-w-md grid grid-cols-2 gap-4"><InputGroup label="空腹血糖 (AC)"><NumberInput value={glu} onChange={setGlu} placeholder="mg/dL" /></InputGroup><InputGroup label="空腹胰島素"><NumberInput value={ins} onChange={setIns} placeholder="µU/mL" /></InputGroup><div className="col-span-2"><ResultCard title="HOMA-IR" result={result} copyContent={copyText} /></div></div>); };

export const MetSCalculator: React.FC = () => { const [waist, setWaist] = useState(false); const [bp, setBp] = useState(false); const [glu, setGlu] = useState(false); const [tg, setTg] = useState(false); const [hdl, setHdl] = useState(false); const [result, setResult] = useState<CalculatorResult|null>(null); useEffect(() => setResult(checkMetabolicSyndrome(waist, bp, glu, tg, hdl)), [waist, bp, glu, tg, hdl]); const positives = [waist&&'Waist', bp&&'BP', glu&&'Glu', tg&&'TG', hdl&&'HDL'].filter(Boolean).join(', '); const copyText = formatEMR('Metabolic Syndrome', positives || 'None', result); return ( <div className="max-w-md space-y-2"> <p className="text-base font-black text-black mb-4">請勾選符合的項目：</p> <Checkbox label="腹部肥胖 (男≥90, 女≥80)" checked={waist} onChange={setWaist} /> <Checkbox label="血壓偏高 (SBP≥130 / DBP≥85)" checked={bp} onChange={setBp} /> <Checkbox label="空腹血糖偏高 (FG ≥100)" checked={glu} onChange={setGlu} /> <Checkbox label="TG 偏高 (≥150)" checked={tg} onChange={setTg} /> <Checkbox label="HDL過低 (男<40, 女<50)" checked={hdl} onChange={setHdl} /> <ResultCard title="Metabolic Syndrome Check" result={result} copyContent={copyText} /> </div> ) }

export const BMICalculator: React.FC = () => { const [height, setHeight] = useState<number | ''>(''); const [weight, setWeight] = useState<number | ''>(''); const [result, setResult] = useState<CalculatorResult | null>(null); useEffect(() => { if (height && weight) setResult(calculateBMI(Number(height), Number(weight))); else setResult(null); }, [height, weight]); const copyText = formatEMR('BMI', `H ${height}cm, W ${weight}kg`, result); return ( <div className="max-w-md grid grid-cols-2 gap-6"> <InputGroup label="身高 (cm)"><NumberInput value={height} onChange={setHeight} /></InputGroup> <InputGroup label="體重 (kg)"><NumberInput value={weight} onChange={setWeight} /></InputGroup> <div className="col-span-2"><ResultCard title="BMI" result={result} copyContent={copyText} /></div> </div> ); };

export const FINDRISCCalculator: React.FC = () => { const [age, setAge] = useState(0); const [bmi, setBmi] = useState(0); const [waist, setWaist] = useState(0); const [activity, setActivity] = useState(true); const [diet, setDiet] = useState(true); const [meds, setMeds] = useState(false); const [highGlu, setHighGlu] = useState(false); const [family, setFamily] = useState(0); const [result, setResult] = useState<CalculatorResult|null>(null); useEffect(() => { setResult(calculateFINDRISC(age, bmi, waist, activity, diet, meds, highGlu, family)); }, [age, bmi, waist, activity, diet, meds, highGlu, family]); const copyText = formatEMR('FINDRISC', `Score inputs selected`, result); const Select: React.FC<{label: string, options: {val:number, txt:string}[], val: number, set: any}> = ({label, options, val, set}) => (<div className="mb-4"><label className="block text-base font-bold text-black mb-2">{label}</label><select value={val} onChange={e => set(Number(e.target.value))} className="w-full rounded-lg border-2 border-slate-300 py-2 px-2 text-base bg-white font-bold text-black">{options.map(o => <option key={o.val} value={o.val}>{o.txt}</option>)}</select></div>); return ( <div className="max-w-xl space-y-2"> <Select label="1. 年齡 (Age)" val={age} set={setAge} options={[{val: 0, txt: '< 45 歲 (0分)'}, {val: 2, txt: '45 - 54 歲 (2分)'}, {val: 3, txt: '55 - 64 歲 (3分)'}, {val: 4, txt: '> 64 歲 (4分)'}]} /> <Select label="2. BMI" val={bmi} set={setBmi} options={[{val: 0, txt: '< 25 (0分)'}, {val: 1, txt: '25 - 30 (1分)'}, {val: 3, txt: '> 30 (3分)'}]} /> <Select label="3. 腰圍" val={waist} set={setWaist} options={[{val: 0, txt: '男<90, 女<80 (0分)'}, {val: 3, txt: '男 90-100, 女 80-90 (3分)'}, {val: 4, txt: '男 >100, 女 >90 (4分)'}]} /> <div className="p-4 border-2 border-slate-200 rounded-lg mb-4 bg-white"><p className="font-bold text-black mb-2">4. 每天至少30分鐘運動?</p><div className="flex gap-4"><label className="flex items-center"><input type="radio" checked={activity} onChange={() => setActivity(true)} className="mr-2" /> 是 (0分)</label><label className="flex items-center"><input type="radio" checked={!activity} onChange={() => setActivity(false)} className="mr-2" /> 否 (2分)</label></div></div> <div className="p-4 border-2 border-slate-200 rounded-lg mb-4 bg-white"><p className="font-bold text-black mb-2">5. 每天吃蔬菜水果?</p><div className="flex gap-4"><label className="flex items-center"><input type="radio" checked={diet} onChange={() => setDiet(true)} className="mr-2" /> 是 (0分)</label><label className="flex items-center"><input type="radio" checked={!diet} onChange={() => setDiet(false)} className="mr-2" /> 否 (1分)</label></div></div> <div className="p-4 border-2 border-slate-200 rounded-lg mb-4 bg-white"><p className="font-bold text-black mb-2">6. 曾服用降血壓藥物?</p><div className="flex gap-4"><label className="flex items-center"><input type="radio" checked={!meds} onChange={() => setMeds(false)} className="mr-2" /> 否 (0分)</label><label className="flex items-center"><input type="radio" checked={meds} onChange={() => setMeds(true)} className="mr-2" /> 是 (2分)</label></div></div> <div className="p-4 border-2 border-slate-200 rounded-lg mb-4 bg-white"><p className="font-bold text-black mb-2">7. 曾有血糖偏高病史?</p><div className="flex gap-4"><label className="flex items-center"><input type="radio" checked={!highGlu} onChange={() => setHighGlu(false)} className="mr-2" /> 否 (0分)</label><label className="flex items-center"><input type="radio" checked={highGlu} onChange={() => setHighGlu(true)} className="mr-2" /> 是 (5分)</label></div></div> <Select label="8. 糖尿病家族史" val={family} set={setFamily} options={[{val: 0, txt: '無 (0分)'}, {val: 3, txt: '旁系親屬 (3分)'}, {val: 5, txt: '直系親屬 (5分)'}]} /> <ResultCard title="FINDRISC" result={result} copyContent={copyText} /> </div> ); }
